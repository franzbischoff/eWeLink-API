# 接口中心

## 概述

本协议接口统一使用HTTPS协议，客户端向服务端发送数据使用UTF-8编码，使用json格式。

**获取单个设备资源请考虑使用"获取设备或群组的状态接口"，尽量少请求"首页接口"**

### 通用参数

与旧API接口相比，以前的通用参数做如下改动:

* 删除 ts和version参数  
* appid不再通过GET方法的queryString或POST方法的body传入，而是统一通过http headers传入，并且只需在【用户】分类下的接口必须填写，其它接口不再需要  
* nonce不再通过GET方法的queryString或POST方法的body传入，而是统一通过http headers传入，并且校验必须为长度8的字符串，只能为大小写字母和数字  

access token的使用方式不变。总结如下

| **Http Header**   | **是否允许为空**   | **说明**   |
|:----|:----|:----|
| X-CK-Appid   | 【用户】分类下的接口不允许为空   | APPID，APP的标识，需要付费购买的凭证   |
| X-CK-Nonce   | 允许为空   | 长度8的大小写字母和数字，客户端应尽量使用随机字符串，方便和服务端联调   |
| Authorization   | 不允许为空   | API调用凭证，计算方法见[开发文档/签名规则](/zh-cmn/开发文档_v2?id=签名规则)   |
| Content-Type   | PUT和POST的请求不允许为空   | 固定为 application/json   |
| Host   | 不允许为空   | 大部分HTTP客户端会自动添加此字段，如果没有，必须代码明确指定，值为对应的接口域名，比如: cn-apia.coolkit.cn, us-apia.coolkit.cc|

### 接口域名

* 中国: https://cn-apia.coolkit.cn
* 亚洲: https://as-apia.coolkit.cc
* 美洲: https://us-apia.coolkit.cc
* 欧洲: https://eu-apia.coolkit.cc

注意: 中国区（内陆）的域名为 **.cn**，其它地区环境的域名为 **.cc**

### 接口返回格式

本协议所有接口返回的数据都使用UTF-8编码，使用json格式。数据格式如下

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| error   | Int   | N   | 错误码，0代表无错误，1000以内为通用错误码，参见本协议的【通用错误码】部分，1000以上的错误码由不同接口给出定义   |
| data   | Object   | N   | 接口数据   |
| msg   | String   | N   | 错误信息，error=0时为空字符串""，其它情况根据不同接口给出，以便调试   |

举例1: 接口成功返回

```json
{
  "error": 0,
  "msg": "",
  "data": {
    "data1": "xxx",
    "data2": "yyy"
  }
}
```

举例2: 接口错误返回

```json
{
  "error": 403,
  "msg": "api not found",
  "data": {}
}
```

## 用户

### 账号注册

URL: /v2/user/register

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| countryCode   | String   | N   | 国家码区号，必须以"+"开头，比如"+86"   |
| email   | String   | Y   | 邮箱地址，不区分大小写（系统自动存小写）   |
| phoneNumber   | String   | Y   | 手机号 （优先检查）  以国家码开头，比如"+8618023456789" email和phoneNumber必须二选一填写一个，否则报错   |
| verificationCode   | String   | N   | 短信/邮箱验证码   |
| password   | String   | N   | 密码   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| user   | Object   | N   | 用户信息   |
| at   | String   | N   | Access Token    |
| rt   | String   | N   | Refresh Token   |
| region   |  String   | N   | 用户所属区域  cn=中国区  as=亚洲区  us=美洲区  eu=欧洲区   |

user说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| countryCode   | String   | Y   | 国家码区号，以"+"开头，比如"+86"   |
| phoneNumber   | String   | Y   | 用户手机号，带国家码格式:+8615815725225   |
| email   | String   | Y      | 用户邮箱  用户手机和邮箱不会同时为空   |
| apikey   | String   | N   | 用户id   |
| nickname   | String   | Y   | 用户昵称   |
| wxServiceId   | String   | Y   | 绑定的微信服务号ID   |
| wxAppId   | String   | Y   | 微信服务号appID   |
| wxId   | String   | Y   | 微信用户ID   |
| wxOpenId   | String   | Y   | 微信用户OpenID   |
| yanKanYunInfo   | Object   | Y   | 遥看云账号信息   |
| accountLevel   | Int   | N   | 账号等级  10=Free  20=Advanced  30=Pro   |
| levelExpiredAt   | Long   | Y   | 会员等级到期时间戳，精确到毫秒，如果字段为空或0，表示没有过期时间   |
| denyRecharge   | Boolean   | Y   | 当前的账号是否已经无法充值会员，字段为空或者值为false，代表可以充值，值为true，代表禁止充值   |
| accountConsult   | Boolean   | Y   | 是否接受过会员咨询反馈   |
| ipCountry   | String   | Y   | 后台根据接口调用ip算出的用户所在国家和地区，国家地区码参见 [这里](https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes)（需翻墙）的Alpha-2 code说明。请求 "获取用户信息" 或 “首页” 接口（带上getUser参数）时，服务端就会返回这个字段。   |

错误响应参见登录接口

### 账号登录

URL: /v2/user/login

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| lang   | String   | Y   | cn返回中文信息，en返回英文信息，默认en   |
| countryCode   | String   | N   | 国家码区号，必须以"+"开头，比如"+86"   |
| email   | String   | Y   | 邮箱地址，不区分大小写   |
| phoneNumber   | String   | Y   | 手机号 （优先检查）  以国家码开头，比如“+8618023456789”  email和phoneNumber必须二选一填写一个，否则报错   |
| password   | String   | N   | 密码   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| user   | Object   | N   | 用户信息，参见【注册】接口   |
| at   | String   | N   | Access Token    |
| rt   | String   | N   | Refresh Token   |
| region   |  String   | N   | 用户所属区域  cn=中国区  as=亚洲区  us=美洲区  eu=欧洲区   |

当error为10004时，表示账号不在当前区域，客户端需要根据返回的区域信息重新去其它区调用登录接口。返回数据举例如下:

```json
{
  "error": 10004,
  "msg": "redirection",
  "data": { "region": "eu" }
}
```

### 使用短信验证码登录
URL: /v2/user/sms-login

请求方法:  post

说明:

**此接口目前仅限中国区手机号**

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| countryCode   | String   | N   | 国家码区号，必须以"+"开头，比如"+86"   |
| lang   | String   | Y   | cn返回中文信息，en返回英文信息，默认en   |
| phoneNumber   | String   | N   | 手机号  以国家码开头，比如“+8618023456789”   |
| verificationCode   | String   | N   | 短信验证码   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| user   | User   | N   | 用户信息，参见【注册】接口   |
| at   | String   | N   | Access Token   |
| rt   | String   | N   | Refresh Token   |
| region   | String   | N   | 用户所属区域代码  cn=中国区  as=亚洲区  us=美洲区  eu=欧洲区   |

错误响应参见登录接口

### 发送验证码

URL: /v2/user/verification-code

请求方法:  post

说明: 对同一个邮箱或者手机号，有发送频次限制如下:

* 1分钟内不能超过3次
* 1小时内不能超过20次
* 1天内不能超过100次

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| type   | Int   | N   | 验证码类型  0: 注册  1: 重置密码  3: 注销账号  4: 验证码登录   |
| email   | String   | Y   | 发送的邮箱地址，区分大小写   |
| phoneNumber   | String   | Y   | 发送的手机号，以国家码开头，比如“+8618023456789”  email和phoneNumber必须二选一填写一个，否则报错   |

当error为10004时，表示账号不在当前区域，客户端需要根据返回的区域信息重新去其它区调用登录接口。返回数据举例如下：

```json
{
  "error": 10004,
  "msg": "redirection",
  "data": { "region": "eu" }
}
```

响应data参数: 无

### 重置密码

URL: /v2/user/reset-pwd

说明: 用户如果忘记密码，可以使用该接口重新设置密码

请求方法:  post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| email   | String   | Y   | 邮箱地址，不区分大小写   |
| phoneNumber   | String   | Y   | 手机号，以国家码开头，比如“+8618023456789”  email和phoneNumber必须二选一填写一个，否则报错   |
| verificationCode   | String   | N   | 验证码   |
| password   | String   | N   | 密码   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| user   | Object   | N   | 用户信息，参见【注册】接口   |
| at   | String   | N   | Access Token    |
| rt   | String   | N   | Refresh Token   |
| region   |  String   | N   | 用户所属区域  cn=中国区  as=亚洲区  us=美洲区  eu=欧洲区   |

### 修改密码

URL: /v2/user/change-pwd

请求方法:  post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| oldPassword   | String   | N   | 原密码   |
| newPassword   | String   | N   | 新密码   |

响应data参数: 无

### 获取用户信息

URL: /v2/user/profile

请求方法: get

请求参数:

无

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| user   | Object   | N   | 用户信息，参见【注册】接口   |
| region   |  String   | N   | 用户所属区域  cn=中国区  as=亚洲区  us=美洲区  eu=欧洲区   |

### 更新用户信息

URL: /v2/user/profile

请求方法:  post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| nickname   | String   | Y   | 要更新的用户昵称,如果字段为空或NULL，表示不更新昵称   |
| acceptEmailAd   | Boolean   | Y   | 是否接受邮件订阅广告,如果字段为空或NULL，表示不更新   |
| accountConsult   | Boolean   | Y   | 是否接受过会员咨询反馈,固定值 true，填写其它值则返回参数错误,如果字段为空或NULL，表示不更新   |

响应data参数: 无

### 刷新认证token

URL: /v2/user/refresh

请求方法:  post

说明: Access Token缺省30天失效（安全原因），此时可以不用重新登录获取Access Token，而是使用 Refresh Token刷新获取Access Token

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| rt   | String   | N   | Refresh Token   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| at   | String   | N   | Access Token   |
| rt   | String   | N   | Refresh Token   |

### 退出登录

URL: /v2/user/logout

请求方法：delete

请求参数：无

响应data参数：无

### 注销账号

URL: /v2/user/close-account

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| verificationCode   | String   | N   | 验证码 |

响应data参数: 无

## 首页

### 获取首页信息

URL: /v2/homepage

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| lang   | String   | Y   | cn返回中文信息，en返回英文信息，默认en   |
| clientInfo   | Object   | Y   | 客户端信息   |
| getUser   | Object   | Y   | 如果要获取用户信息，则填写此字段   |
| getFamily   | Object   | Y   | 如果要获取家庭信息，则填写此字段  将会得到所有家庭的信息   |
| getThing   | Object   | Y   | 如果要获取Thing信息，则填写此字段  只会取得当前家庭下的Thing信息   |
| getScene   | Object   | Y   | 场景列表，暂未开放   |
| getMessage   | Object   | Y   | 如果要获取消息中心的通知信息，则填写此字段  只会取得当前家庭下的通知信息   |

clientInfo说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| model   | String   | Y   | 手机型号，比如 "M6 Note"   |
| os   | String   | Y   | 操作系统，值为"Android"或"iOs"   |
| imei   | String   | Y   | 手机IMEI号   |
| romVersion   | String   | Y   | 手机的android/ios系统版本号   |
| appVersion   | String   | Y   | App版本   |


getThing说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| num   | Int   | Y   | 获取的数量，不填则默认为30  0表示获取所有   |
| beginIndex   | Int   | Y   | 从哪个序号开始获取列表数据，不填则默认为-9999999   |

getMessage说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| from   | Long   | Y   | 时间戳，精确到毫秒，表示从什么时间开始，获取更早之前的消息，不填则默认为当前时间   |
| num   | Int   | Y   | 最多拉取的消息数量，1<= num <= 30，不填则默认为30   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| userInfo   | Object   | Y   | 参见【注册】接口中的user说明   |
| familyInfo   | Object   | Y   | 参见【获取家庭和房间列表】接口中的data响应说明   |
| thingInfo   | Object   | Y   | 参见【获取Thing列表】接口中的data响应说明   |
| sceneInfo   | Object   | Y   | 参见【获取场景列表】接口中的data响应说明   |
| messageInfo   | Object   | Y   | 参见【获取通知消息列表】接口中的data响应说明   |

客户端调用示例：

```json
{
  "lang": "cn",
  "clientInfo": {
    "model": "xxx"
  },
  "getUser": {},
  "getFamily": {},
  "getThing": {
    "num": 10
  },
  "getScene": {},

  "getMessage": {}
}
```

## 设备 

### 获取全部设备列表（不支持）

URL: 无

请求方法： get

请求参数：无

响应data参数：

| **名称**   | **类型**   | **允许空**   | **说明**   |
|:----|:----|:----|:----|
| deviceList   | Array\<Object\>   | N   | 设备列表   |

deviceList列表item说明：

| **名称**   | **类型**   | **允许空**   | **说明**   |
|:----|:----|:----|:----|
| name   | String   | N   | 设备名称   |
| deviceid   | String   | N   | 设备ID   |
| apikey   | String   | N   | 设备所属用户的apikey   |
| extra   | Object   | N   | factoryDevice的extra字段中的内容   |
| brandName   | String   | N   | 品牌名称   |
| brandLogo   | String   | N   | 品牌Logo url   |
| showBrand   | Boolean   | N   | 是否显示品牌   |
| productModel   | String   | N   | 产品型号名称   |
| devGroups   | Array\<Object\>   |  Y   | 设备所属的群组信息列表   |
| tags   | Object   | Y    | 标签对象，里面是存储的是自定义字符串，服务器只负责透传   |
| devConfig   | Object   | Y   | 设备端配置信息，来源于factorydevices表的deviceConfig。   |
| settings   | Object   | Y    | 用户设置，参见【修改设备配置】接口说明   |
| family   | Object   | N   | 设备的家庭设置   |
| sharedBy   | Object   | Y    | 如果设备是别人分享过来的，就会有该属性。   |
| shareTo   | Array\<Object\>   | Y   | 被分享用户的列表，表示用户把设备分享给了哪些人。   |
| devicekey   | String   | N    | 设备的出厂apikey   |
| online   | Boolean   | N    | 在线状态   |
| params   | Object   | Y   | 设备的状态属性   |
| gsmInfoData   | Object   | Y   | GSM设备的卡状态对象   |

devGroups说明：

| **名称**   | **类型**   | **允许空**   | **说明**   |
|:----|:----|:----|:----|
| type   | Int   | N   | 1代表设备群组   |
| groupId   | String   | N   | 所属群组的id   |

sharedBy和shareTo列表item说明：

| **名称**   | **类型**   | **允许空**   | **说明**   |
|:----|:----|:----|:----|
| apikey   | String   | N   | 设备所属用户的apikey   |
| phoneNumber   | String   | Y   | 设备所属用户手机号   |
| email   | String   | Y   | 设备所属用户email   |
| nickname   | String   | Y   | 设备所属用户的昵称   |
| permit   | Int   | N   | 用户的权限值，默认为0   |
| comment   | String   | Y   | 分享时的备注   |
| shareTime   | Long   | Y   | GMT标准时间，毫秒数，主要用来在客户端显示排序。   |

devConfig说明（摄像头）：

| **名称**   | **类型**   | **允许空**   | **说明**   |
|:----|:----|:----|:----|
| p2pServerName   | String   | Y   | 服务器名称   |
| p2pAccout   | String   | Y   | 账号   |
| p2pLicense   | String   | Y   | license   |

family说明：

| **名称**   | **类型**   | **允许空**   | **说明**   |
|:----|:----|:----|:----|
| familyid   | String   | N   | 家庭id   |
| index   | Int   | N   | 设备排序号  可能存在负数   |
| roomid   | String   | Y   | 所属房间id   |

### 获取Thing列表

URL: /v2/device/thing

请求方法: get

说明: Thing包括

* 设备（自己的和别人分享的）
* 设备群组

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| lang   | String   | Y   | cn返回中文信息，en返回英文信息，默认en   |
| familyid   | String      | Y   | 家庭id，不填则默认为当前家庭   |
| num   | Int   | Y   | 获取的数量，默认为30  0表示获取所有   |
| beginIndex   | Int   | Y   | 从哪个序号开始获取列表数据，不填则默认为-9999999   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| thingList   | Array   | N   | Thing列表   |
| total   | Int   | N   | Thing总数量（设备+设备群组）   |

thingList列表item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型  1=用户自己的设备  2=别人分享的设备  3=自己的群组    |
| itemData   | Object   | N   | 根据itemType有不同的结构  1和2时参见【获取全部设备列表】接口中的deviceList列表item说明  3时参见【获取设备群组列表】接口中的groupList列表item说明   |
| index   | Int   | N   | 排序号   |

### 获取指定Thing列表信息

URL: /v2/device/thing

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| thingList   | Array   | N   | 需要获取的thing列表列表数量必须大于0，小于等于10   |

thingList item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型  1=用户自己的设备  2=别人分享的设备  3=自己的群组    |
| id   | String   | N   | thing对应的id,itemType为1或2时为设备的deviceid,itemType为3或4时为群组id   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| thingList   | Array   | N   | Thing列表信息，参见【获取thing列表】中的说明   |

### 获取设备或群组的状态

URL: /v2/device/thing/status

请求方法: get

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| type   | Int   | N   | 要获取设备还是群组1=设备  2=群组   |
| id   | String   | N   | type=1时为设备的deviceid  type=2时为群组id   |
| params   | String   | Y   | 需要获取的状态参数   |

**params说明**

调用方可以指定只获取特定的状态参数，以"|"间隔，再做URL转换。 

举例: 想要得到 switch 和 light 两个状态

1. 构造字符串 switch|light
2. 对(1)的字符串做URL转换，得到字符串 switch%7Clight，即为发送给接口params参数的值

如果要获取设备或群组所有的状态，params参数为空即可

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| params   | Object   | N   | 设备或群组的状态属性   |

### 更新设备或群组的状态

URL: /v2/device/thing/status

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| type   | Int   | N   | 要更新设备还是群组1=设备2=群组 |
| id   | String   | N   | type=1时为设备的deviceid  type=2时为群组id   |
| params   | Object   | N   | 更新的状态参数   |

**params说明**

* 更新设备时，会向设备下发控制指令，如果设备不在线或发送失败，会返回错误
* 更新群组时，会向群组下的所有设备发送控制指令，并忽略设备不在线或发送失败的情况

响应data参数: 无

### 批量更新设备或群组的状态

说明：该接口会实际向设备下发控制指令，是为不能走长连接更新状态的设备准备的

URL: /v2/device/thing/batch-status

请求方法：post

请求参数：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| thingList   | Array\<Object\>  | N   | 要更新的thing列表，长度大于0，小于等于10，客户端需保证列表中的id是唯一的，否则报错|
| timeout   | Int   | Y   | 等待所有设备响应的时间，单位毫秒， 0 <= timeout <= 8000 ，如果不填则默认为0，表示立即返回   |

thingList列表中item的说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| type   | Int  | N   | 要更新设备还是群组，1=设备 2=群组|
| id   | String   | N   | type=1时为设备的deviceid，type=2时为群组id   |
| params   | Object   | N   | 要更新的状态参数   |

响应data参数：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| respList   | Array\<Object\>  | N   | 每个thing的响应结果列表|

respList列表中item的说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| type   | Int  | N   | 要更新设备还是群组，1=设备 2=群组|
| id   | String   | N   | type=1时为设备的deviceid，type=2时为群组id   |
| error   | Int   | N   | 响应错误码，0代表无错误如果type=2，则error固定为0如果调用时timeout为0，则error固定为0 |

### 添加WiFi设备

URL: /v2/device/add

请求方法: post

说明: 新增普通的WiFi设备

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| name   | String   | N   | 设备名称   |
| deviceid   | String   | N   | 设备id   |
| settings   | Object   | Y   | 用户设置  如果没有则采用默认值   |
| ifrCode   | String   | Y   | 红外设备的码值   |
| digest   | String   | N   | sha256(deviceid+设备apikey)小写字符串   |
| chipid   | String   | Y   | 设备的芯片id   |
| familyid   | String   | Y   | 设备所属的家庭id，如果为空，表示添加到当前家庭   |
| roomid   | String   | Y   | 设备所属的房间id，如果为空，表示添加到【未分配】下   |
| sort   | Int   | Y   | 给新设备分配序号的方式，如果为空则默认为1  1=更小的序号  2=更大的序号   |

digest算法：

比如：123
sha256结果：a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3

settings说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| opsNotify   | Int   | Y   | 操作变化是否通知用户（默认0）0=不通知 1=通知   |
| opsHistory   | Int   | Y   | 是否记录操作历史（默认1）0=不记录 1=记录   |
| alarmNotify   | Int   | Y   | 是否发送告警信息（默认1）0=不发送 1=发送   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型，这里固定为1   |
| itemData   | Object   | N   | 参见【获取全部设备列表】接口中的deviceList列表item说明   |
| index   | Int   | N   | 排序号   |

说明：如果报30017错误，原因是设备所属的品牌并没有授权给你的APPID，目前酷宅自有品牌是免费授权的，但其他厂商的品牌会保留使用权限，授权相关的问题可在微信对接群咨询我司市场部销售人员。

```
{
   "error": 30017,
   "msg": "this app does not support of adding this brand and its device",
   "data": {}
}
```

### 新增GSM设备

URL: /v2/device/add-gsm

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 从扫描设备上的二维码URL中获取设备gsmId，URL格式： https://api.coolkit.cc:8080/api/user/device/addGsm?id=348512d49379bb0acace4598e14fc450，id是后面那个参数  |
| name   | String   | N   | 设备名称   |
| familyid   | String   | Y   | 设备所属的家庭id，如果为空，表示添加到当前家庭   |
| roomid   | String   | Y   | 设备所属的房间id，如果为空，表示添加到【未分配】下   |
| sort   | Int   | Y   | 给新设备分配序号的方式，如果为空则默认为1  1=更小的序号  2=更大的序   |

备注：应用扫描设备上的二维码可以获取到一个URL格式的字符串，请注意域名是有可能改变的，但 "/addGsm?id={gsmId}" 不会改变。

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型，这里固定为1   |
| itemData   | Object   | N   | 参见【获取全部设备列表】接口中的deviceList列表item说明   |
| index   | Int   | N   | 排序号   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| thingList   | Array   | N   | 成功添加的设备列表  由于添加第三方设备时，可能一次添加多个设备，所以这里返回列表   |

thingList列表中item的说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型，这里固定为1   |
| itemData   | Object   | N   | 参见【获取全部设备列表】接口中的deviceList列表item说明   |
| index   | Int   | N   | 排序号   |

### 更新设备的名称/房间信息

URL: /v2/device/update-info

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |
| name   | String   | Y   | 设备名称   |
| roomid      | String   | Y   | 房间id，只能更换到设备所在家庭下的房间，不能跨家庭更改   |

响应data参数: 无

### 删除设备

URL: /v2/device

说明: 删除其他人分享给自己的设备也是通过此接口删除的

请求方法: delete

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 要删除的设备ID   |

响应data参数: 无

### 修改设备标签

可修改子通道名称，可按照自己想法实现一些特定功能

URL: /v2/device/tags

请求方法: post

说明: 需要将完整的tags对象传过来，服务端整体覆盖原有的值

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |
| type   | String   | Y   | 修改类型，不填则默认为replace，replace=覆盖，merge=合并   |
| tags   | Object   | N   | 设备标签   |

说明：假设设备原有标签为

```json
{"key1":"value1", "key2":"value2"}
```

当传入的参数type=replace，tags为 {"key3":"value3"}，则更新后的标签为：

```json
{"key3":"value3"}
```

当传入的参数type=merge，tags为 {"key3":"value3"}，则更新后的标签为：

```json
{"key1":"value1", "key2":"value2", "key3":"value3"}
```

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| updatedThing   | Object   | N   | 更新后的thing数据   |

### 获取设备群组列表

URL: /v2/device/group

请求方法: get

说明:

1. 设备群组与设备一同排序
2. 只获取当前家庭下的设备群组列表

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| lang   | String   | Y   | cn返回中文信息，en返回英文信息，默认en   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| groupList   | Array   | N   | 群组列表   |

groupList列表item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型，这里固定为3   |
| itemData   | Object   | N   | 群组的信息   |
| index   | Int   | N   | 排序号   |

itemData说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 群组id   |
| name   | String   | N   | 群组名称   |
| mainDeviceId   | String   | N   | 群组的主设备id   |
| family   | Object   | N   | 群组的家庭设置   |
| params   | Object   | N   | 群组状态   |

family说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| familyid   | String   | N   | 家庭id   |
| index   | Int   | N   | 群组排序号  可能存在负数   |
| roomid   | String   | Y   | 所属房间id   |

### 新增设备群组

URL: /v2/device/group

请求方法: post

说明: 如果使用别人分享的设备作为主设备来新增群组，则当分享撤销时，该群组也会被一并删除

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| name   | String   | N   | 群组名称   |
| mainDeviceId   | String   | N   | 群组的主设备id   |
| familyid   | String   | Y   | 群组所属的家庭id，如果为空，表示添加到当前家庭   |
| roomid   | String   | Y   | 群组所属的房间id，如果为空，表示添加到【未分配】下   |
| sort   | Int   | Y   | 给新群组分配序号的方式  1=更小的序号  2=更大的序号    |
| deviceidList   | Array\<String\>   | Y   | 创建群组时加入到该群组的设备的id列表，不需要将主设备id传入，如果列表中的设备uiid与主设备的不一致，则不会将该设备添加到群组|

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型，这里固定为3   |
| itemData   | Object   | N   | 参见【获取设备群组列表】接口中的itemData说明   |
| index   | Int   | N   | 排序号   |
| updatedThingList   | Array\<Object\>   | N   | 更新后的things列表数据，内容包括群组的主设备信息   |

### 修改设备群组

URL: /v2/device/group

请求方法: put

说明: 目前此接口只能修改群组的名称

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 群组id   |
| name   | String   | N   | 修改的群组名称   |

响应data参数: 无

### 删除设备群组

URL: /v2/device/group

请求方法: delete

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 群组id   |

响应data参数: 无

### 更改群组状态

URL: /v2/device/group/status

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 群组id   |
| params   | Object   | N   | 群组状态，接口只保存数据，不做处理   |

响应data参数: 无

### 设备群组新增设备

URL: /v2/device/group/add

请求方法: post

说明: 新增设备的uiid必须与群组主设备的uiid一致

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 群组id   |
| deviceidList   | Array   | N   | 设备id列表，数量最小1，最大30   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| updatedThingList   | Array   | N   | 更新后的thing数据   |

### 设备群组删除设备

URL: /v2/device/group/delete

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 群组id   |
| deviceidList   | Array\<String\>    | N   | 设备id列表，数量最小1，最大30   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| updatedThingList   | Array   | N   | 更新后的thing数据   |

### 更新设备群组的设备列表

URL: /v2/device/group/update

说明：该接口会根据传入的设备列表，对群组内的设备做全量覆盖

请求方法：post

请求参数：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 群组id   |
| deviceidList   | Array\<String\>   | N   | 设备id列表，必须最少包含群组的主设备deviceid，否则报错|

响应data参数：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| updatedThingList   | Array   | N   | 更新后的thing数据   |

### 设备分享

URL: /v2/device/share

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceidList   | Array<String>   | N   | 设备id列表   |
| user   | Object   | N   | 用户信息   |
| permit   | Int   | N   | 权限值之和，采用位移操作计算，权限值定义：1：新增定时器；2：修改定时器；4：删除定时器；8：启用定时器   |
| comment   | String   | Y   | 分享备注   |
| shareType   | Int   | Y   | 分享方式，不填则默认为1，1=静默分享，不需要被分享的用户同意   |

user说明：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| countryCode   | String   | Y   | 国家码区号，phoneNumber不为空时必须填写   |
| phoneNumber   | String   | Y   | 用户手机号码，必须以国家区号开头，比如"+86"   |
| email   | String   | Y  | 用户email，手机号码和email不能同时为空，优先检查手机号码   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| updatedThingList   | Array   | N   | 更新后的thing数据，参见【新增设备】接口的data响应说明，里面包含了分享用户的信息   |

备注: post /v2/device/share 会返回对方的apikey参数，可以记下来，在 post /v2/device/share/permit和 delete /v2/device/share 会用到。

### 修改设备分享的权限

URL: /v2/device/share/permit

请求方法：post

请求参数：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |
| apikey   | String   | N   | 要修改分享权限的用户apikey   |
| permit   | Int   | N  | 修改的权限，参见【设备分享】接口参数的说明   |

Note: apikey 参数来自于设备的详情信息，请在文档中搜索shareTo这个参数。

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| updatedThingList   | Array   | N   | 更新后的thing数据，参见【新增设备】接口的data响应说明，里面包含了分享用户的信息   |

### 取消设备分享

URL: /v2/device/share

请求方法：delete

请求参数：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |
| apikey   | String   | N   | 要修改分享权限的用户apikey   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| updatedThingList   | Array   | N   | 更新后的thing数据，参见【新增设备】接口的data响应说明，里面包含了分享用户的信息   |

### 获取设备的操作历史记录

URL: /v2/device/history

请求方法: get

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |
| from   | Long   | Y   | 时间戳，精确到毫秒，表示从什么时间开始，获取更早之前的消息，不填则默认为当前时间   |
| num   | Int   | Y   | 最多拉取的消息数量，1<= num <= 30，不填则默认为30   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| histories | Array   | N   | 历史记录列表   |

histories item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |
| userAgent   | String   | Y   | 用户区分是设备端还是app端的操作   |
| opsSwitchs   | String   | Y   | 记录被操作的通道值。如果是单通道就只有1个元素，值为"switch"   |
| request   | String   | N   | 原始的request请求   |
| opsAccount   | String   | Y   | 如果是app端的操作，返回操作人的账号（有可能是分享用户的）   |
| opsTime   | Long   | N   | 操作时间戳，精确到毫秒   |

### 清除设备的操作历史记录

URL: /v2/device/history

请求方法: delete

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |

响应data参数: 无

### 查询设备的 OTA 信息

URL: /v2/device/ota/query

请求方法：post

请求参数

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceInfoList   | Array\<Object\>   | N   | 要查询的设备信息列表，列表长度大于0，小于等于30   |

deviceInfoList列表item说明：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String   | N   | 设备id   |
| model   | String  | N   | 设备的模块型号 |
| version   | String  | N   | 当前设备的固件版本号 |

响应data参数：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| otaInfoList   | Array\<Object\>  | N   | OTA 信息列表，如果设备有升级的信息，则会在这个列表中 |

otaInfoList列表item说明：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| deviceid   | String  | N   | 设备id |
| version   | String  | N   | 最新的固件版本号 |
| binList   | Array\<Object\>  | N   | 不同分区的bin列表 |
| type   | String  | N   | （保留字段） |
| forceTime   | String  | N   | （保留字段） |

binList列表item说明：

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| name   | String  | N   | 下载文件名称 |
| downloadUrl   | String  | N   | 下载地址 |
| digest   | String  | Y   | 文件 HASH 摘要（SHA256） |

固件升级：

APP获取到固件信息后，显示可升级提示，用户点击升级，APP应通过长连接下发OTA指令：

```
{
    "action":"upgrade",
    "deviceid":"设备ID",
    "apikey":"用户APIKEY",
    "userAgent":"app",
    "sequence":"毫秒级时间戳",
    "ts":0,
    "params":{
        "model":"设备Model",
        "version":"预升级版本号",
        "binList":[
            {
                "downloadUrl":"bin文件1下载地址",
                "digest":"文件 HASH 摘要（SHA256）",
                "name":"user1.bin"
            },
            {
                "downloadUrl":"bin文件2下载地址",
                "digest":"文件 HASH 摘要（SHA256）",
                "name":"user2.bin"
            }
        ]
    }
}
```

设备如果验证正确，会回复（固件版本不同，也有可能不回复而是直接断开连接去OTA）：

```
{
    "userAgent":"device",
    "apikey":"用户APIKEY",
    "deviceid":"设备ID",
    "error":0,
    "sequence":"毫秒级时间戳(与APP发送的一致)"
}
```

这时候APP应显示正在升级中（OTA进度无法确认），并存储此次OTA前原版本信息，设备OTA升级过程中会重启，重启后设备上报最新固件版本号，APP收到后与存储的原固件版本对比，大于原固件版本号则判断为升级成功，否则其他情况都应为失败。

## 家庭和房间

### 获取家庭和房间列表

URL: /v2/family

请求方法:  get

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| lang   | String   | Y   | cn返回中文信息，en返回英文信息，默认en   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| familyList   | Array   | N   | 家庭列表   |
| currentFamilyId   | String   | N   | 当前所在家庭的id   |

familyList列表item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 家庭id   |
| name   | String   | N   | 家庭名称   |
| index   | Int   | N   | 家庭排序号  可能存在负数      |
| roomList   | Array   | Y   | 房间列表   |

roomList列表item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 房间id   |
| name   | String   | N   | 房间名称   |
| index   | Int   | N   | 房间排序号  可能存在负数   |

### 新增家庭

URL: /v2/family

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| name   | String   | N   | 家庭名称   |
| sort   | Int   | N   | 给新家庭分配序号的方式  1=更小的序号  2=更大的序号   |
| roomNameList   | Array   | Y   | 房间名称列表  服务端按列表顺序对新创建的房间生成对应序号   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 家庭id   |
| name   | String   | N   | 家庭名称   |
| index   | Int   | N   | 家庭排序号   |
| roomList   | Array\<Object\>   | Y   | 房间列表，参见【获取家庭和房间列表】接口的说明      |

### 新增房间

URL: /v2/family/room

请求方法: post

说明: 每个家庭下最多允许有100个房间

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| familyid   | String   | N   | 房间所属的家庭id      |
| name   | String   | N   | 房间名称   |
| sort   | Int   | N   | 给新房间分配序号的方式  1=更小的序号  2=更大的序号   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 房间id   |
| name   | String   | N   | 房间名称   |
| index   | Int   | N   | 房间排序号   |

### 修改家庭信息

URL: /v2/family

请求方法: put

说明: 当前只支持修改家庭名称

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | Y   | 家庭id，不填则为修改当前家庭   |
| name   | String   | N   | 新的家庭名称   |

响应data参数: 无

### 修改房间信息

URL: /v2/family/room

请求方法: put

说明: 当前只支持修改房间名称

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 房间的id   |
| name   | String   | N   | 新的房间名称   |

响应data参数: 无

### 对房间做排序

URL: /v2/family/room/index

请求方法: post

说明: 客户端必须将家庭下的所有房间上传，统一排序

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| familyid   | String   | Y   | 家庭id，不填则为修改当前家庭      |
| idList   | Array   | N   | 房间的id列表，服务端按照列表的顺序对相应位置的id作排序，比如列表序号0的房间的index即为0   |

响应data参数: 无

### 删除家庭

URL: /v2/family

请求方法: delete

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 家庭id   |
| deviceFamily   | String   | N   | 表示把将要删除的家庭下的设备迁移到另一个家庭的id   |
| switchFamily   | String   | N   | 表示删除家庭后要切换到的家庭id   |

响应data参数: 无

### 删除房间

URL: /v2/family/room

请求方法: delete

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 房间id   |

响应data参数: 无

### 对家庭下的Thing做排序

URL: /v2/family/thing/sort

请求方法: post

说明: 客户端必须将家庭下的所有设备和群组上传，统一排序

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| familyid   | String   | Y   | 家庭id，如果为空，表示对当前家庭下的设备/群组做排序   |
| thingList   | Array\<Object\>   | N   | thing列表，服务端按照列表的顺序对相应位置的id作排序，比如列表序号0的设备/群组的index即为0   |

thingList列表item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| itemType   | Int   | N   | item的类型  1=用户自己的设备  2=别人分享的设备  3=自己的群组    |
| id   | String   | N   | 设备deviceid / 群组id   |

响应data参数: 无

### 设置房间的Thing

URL: /v2/family/room/thing

请求方法: post

说明: 客户端将房间原有的thing列表和调整后的thing列表传入，服务端据此计算出要从房间删除的thing，以及要添加到房间的thing。客户端应保证oldThingList的正确性，如果有遗漏项，可能导致从房间删除失败；如果其中一项不属于roomid所属的房间，服务端返回错误

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| roomid   | String   | N   | 房间id   |
| oldThingList   | Array   | N   | 原来房间的thing列表，如果为空，则传入空列表 []，列表的item参见【对家庭下的Thing做排序】中的thingList列表item说明   |
| newThingList   | Array   | N   | 调整后房间的thing列表   |

响应data参数: 无

### 切换当前家庭

URL: /v2/family/current

请求方法: post

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| id   | String   | N   | 家庭id   |

响应data参数: 无 

## 消息中心

### 获取通知消息列表

URL: /v2/message/read

请求方法: get

说明: 列表按时间排序，客户端如果要获取更多的数据，可以根据最后一个item的时间戳，再此调用此接口，将时间戳填到from字段中

请求参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| familyid   | String   | Y   | 家庭id，如果不填则默认为当前家庭   |
| from   | Long   | Y   | 时间戳，精确到毫秒，表示从什么时间开始，获取更早之前的消息，不填则默认为当前时间   |
| num   | Int   | Y   | 最多拉取的消息数量，1<= num <= 30，不填则默认为30   |

响应data参数:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| messageList   | Array   | N   | 消息列表   |

messageList列表item说明:

| **名称**   | **类型**   | **允许为空**   | **说明**   |
|:----|:----|:----|:----|
| msgid   | String   | N   | 消息id   |
| msgType   | String   | N   | 消息类型  shareNotify_v2: 分享通知  cancelShareNotify_v2: 取消设备分享通知  opsNotify_v2: 设备操作通知  pushNotify_v2: 设备普通推送通知  alarmNotify_v2: 设备报警推送通知  IOTCameraNotify_v2: IOT摄像头推送通知   |
| message   | Object   | N   | 消息内容，不同msgType可以有不同的结构定义   |
| date   | Long   | N   | 消息的时间戳，精确到毫秒   |

响应data参数: 无

## 设备管理与控制

### HTTP : 分配服务（APP）

App使用的长连接分配地址接口

* 中国: [https://cn-dispa.coolkit.cn/dispatch/app](https://cn-dispa.coolkit.cn/dispatch/app)
* 美洲: [https://us-dispa.coolkit.cc/dispatch/app](https://us-dispa.coolkit.cc/dispatch/app)
* 欧洲: [https://eu-dispa.coolkit.cc/dispatch/app](https://eu-dispa.coolkit.cc/dispatch/app)
* 亚洲: [https://as-dispa.coolkit.cc/dispatch/app](https://as-dispa.coolkit.cc/dispatch/app)

请求方法: get

请求参数: 无

说明: 请注意中国区和测试区使用的域名是coolkit.**cn**，而海外区使用的域名是coolkit.**cc**

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| IP | string | N | 长连接服务器外网IP |
| port | number | N | 长连接服务器外网端口 |
| domain | string | N | 长连接服务器域名。目前只有app端才会返回域名。android客户端尽量选择用ip建立长连接，这样可以减少dns解析带来的问题，js版客户端无法跳过证书检查，那么就只能用IP了。 |
| error | number | N | 成功返回error:0 |
| reason | string | N | 成功返回ok |

错误码:

0: 成功

**返回示例:**

```json
{
    "port": 8080,
    "IP": "52.80.19.131",
    "reason": "ok",
    "domain": "cn-pconnect2.coolkit.cc",
    "error": 0
}
```

### WebSocket: 握手

连接建立时的认证，握手分客户端和设备端，此处为客户端的握手。

**注意:**

建立wss连接的时候，客户端会校验访问的域名与证书的域名是否一致，所以默认情况下如果用ip建立连接，会报错，导致建立连接失败。

所以建议客户端跳过证书的域名校验（android和java都可以跳过）。 如果无法跳过证书校验，那么就只能用IP去建立wss连接了。

从【HTTP : 分配服务】获取到要连接的长连接地址，拼接成：wss://IP:端口/api/ws，建立长连接。
握手成功后需要定期（时间间隔见hbInterval字段）发送字符串 ping 到服务器，保持心跳，否则会被服务器强制下线。

以下为参数:

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: userOnline |
| at | string | N | 登录接口获取的AT |
| apikey | string | N | 用户apikey（可从登陆接口获取） |
| appid | string | N | APPID |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒 |
| userAgent | string | N | 固定参数: app |
| sequence | string | N | 时间戳精确到毫秒 |
| version | number | N | 接口版本: 8 |

示例:

```json
{
   "action":"userOnline",
   "version":8,
   "ts":1571141259,
   "at":"登录接口获取的AT",
   "userAgent":"app",
   "apikey":"登录接口获取的用户APIKEY",
   "appid":"McFJj4Noke1mGDZCR1QarGW7P9Ycp0Vr",
   "nonce":"2plz69ax",
   "sequence":"毫秒级时间戳，示例: 1571141530100"
}
// 需去掉空格压缩, 不要带多余的逗号
```

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| apikey | string | N | 用户apikey |
| config | string | Y | 配置信息 |
| sequence | string | N | 时间戳精确到毫秒 |

Config说明:

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| hbl | number | Y | 心跳开关，是否需要发送心跳。0: 不需要， 1: 需要 |
| hbInterval | number | Y | 心跳间隔，以秒为单位，客户端可以把这个值减上7 作为间隔时间发送保持存活ping心跳，如果为空，默认以90秒为间隔发送。 |

易微联客户端的做法是： 间隔时间 = config.hbInterval * random(0.8, 1); // 返回时间*0.8到1.0的随机数

错误码:

0: 成功

**返回示例:**

```json
{
  "error": 0,
  "apikey":"用户APIKEY",
  "config":{
  	"hbl":1,
    "hbInterval": 145
  },
  "sequence": "毫秒级时间戳，示例: 1571141530100" // 和发送的一样
}
```

### WebSocket: 设备上线离线通知（APP接收即可）

服务端检测到设备上线或者下线以后，会向app发送通知指令，该指令app端是**被动接收，不需要客户端主动发送**。

参数:

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: sysmsg |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| nonce | string | N | 8位字母数字随机数 |
| ts | number | N | 时间戳精确到秒， |
| deviceid | string | N | 设备ID |
| params | object | N | 参数: {k:v} |

示例:

```json
{
    "action":"sysmsg",
    "deviceid":"1000000001",
    "apikey":"用户APIKEY",
    "ts": 15452192511,
    "params":{
        "online":false
    }
}
```

### WebSocket: 更新设备状态

**设备状态改变上报update指令后，只要客户端建立了长连接，就可以收到信息，所以建议客户端保持长连接监测设备状态或者发送查询指令获取单个设备状态，而不是定时请求HTTP接口获取设备状态，避免对服务器造成较大的负担。**

更改设备的状态，比如: 定时器、分享、开关状态等。

参数:

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: update |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| deviceid | string | N | 设备ID |
| params | object | N | 服务端对于params参数采用透传方式，可能是对象也可能是对象数组。只需要发送期望改变的状态参数 |
| userAgent | string | N| app或者device|
| sequence | string | N| 时间戳精确到毫秒 |
| ts | number | N | 固定参数: 0|

示例:

```json
{
    "action":"update",
    "deviceid":"100000001",
    "apikey":"用户APIKEY",
    "userAgent":"app",
    "sequence": "1585297259553",
    "ts":0,
    "params":{
        "switch": "on" // 单通道设备
    }
}
```

params说明:

此参数内容来自于协议文档，不同设备不同协议内容，比如 单通道开关只有一个switch，但多通道设备肯定不止一个switch，灯类设备还能调色调光，参数也有所不同。

协议文档需要向对接销售获取，公版易微联APP未对接设备（无UI）的，如果定制界面需要额外付费，具体情况可咨询对接销售。

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N  |错误码 |
| apikey | string | Y | 用户apikey |
| deviceid | string | Y | 设备ID |
| sequence | string | N| 时间戳精确到毫秒 |

示例:

```json
{
    "error": 0,
    "deviceid":"1000000001",
    "apikey": "***************",
    "sequence": "1585297259553"
}
```
错误码:

504: 设备未回应（离线或者指令错误）

**定时器设置**

总体说明，设备可以添加多个定时器，每一次新增、修改、删除定时器的时候，都要全量提交定时器数组。

比如目前定时器有两个，那么如果再新增一个，那么提交的timers数组里，除了新增的这个定时器信息以外还要包含之前那两个定时器的信息。

timers 参数说明：

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| enabled | number | N | 是否启用: 0表示禁用；1表示启用 |
| mId | string | N | 定时标记，可以理解为该定时器的ID，不能重复，UUID格式，可以使用库生成 |
| type | string | N | 设备端使用，单次定时once；重复定时repeat；循环定时duration； |
| coolkit_timer_type | string | N | 客户端使用，单次定时once；重复定时repeat；循环定时duration；延时定时delay |
| at | string | N | 执行时间: 格林尼治时间，也可采用UTC时间 |
| do | object | Y | 要执行的动作 |
| startDo | object | Y | 循环定时专用: 周期开始要执行的动作 |
| endDo | object | Y | 循环定时专用: 随后再执行的动作 |
| period | string | Y | 延时定时专用: 延时时间，单位为分钟 |

示例:

单次定时，也就是只会执行一次:

```json
"params":{
        "timers":[
            {
                "enabled":1, //1表示启用
                "mId":"c102f00f-db6f-fef0-f296-9dd10fdc2193", //UUID格式，可以用库生成，给app用来标记
                "type":"once",  //设备端专用once表示单次定时，repeat重复定时
                "at":"2017-07-24T08:28:00.000Z", //执行的时间 ，注意是GTM时间   0时区
                "do":{   //具体要执行的操作
                    "switch":"on"   //这里是执行打开单通道开关的操作。如果是多通道，这里放的是多通道的开关格式。
                },
                "coolkit_timer_type":"once" //app专用
            }
        ]
    }
```

重复定时:

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"847b296e-9043-ac94-ca37-aa5f91d22338",
                "type":"repeat", //重复执行
                "at":"36 8 * * 1,3",//时间表达式参考cron
                "do":{
                    "switch":"on"
                },
                "coolkit_timer_type":"repeat" //重复执行
            }
        ]
    }
```

循环定时:

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"847b296e-9043-ac94-ca37-aa5f91d22338",
                "type":"duration", 
                "at":"2018-11-21T10:24:00.980Z 10 5",//循环定时执行时间 循环周期 10分钟 再执行 5分钟
                "startDo":{
                    "switch":"on"  //周期开始执行
                },
                "endDo":{
                    "switch":"off"  //随后再执行
                },
                "coolkit_timer_type":"duration" //重复执行
            }
        ]
    }
```

延时定时（指定在多少分钟后执行，也就是单次执行，只是为了可以快速添加定时器）:

```json
"params":{
        "timers":[
            {
                "enabled":1,
                "mId":"95303c64-fbb4-f497-1341-c592432d1d0d",
                "type":"once",
                "at":"2017-07-24T09:10:43.223Z",
                "do":{
                    "switch":"on"
                },
                "period":"30",
                "coolkit_timer_type":"delay"  //延时定时
            }
        ]
    }
```

### WebSocket: 查询设备状态

查询设备的状态，比如: 定时器、分享、开关状态等。

参数:

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| action | string | N | 固定参数: query |
| apikey | string | N | 用户apikey（可从登陆页面获取） |
| deviceid | string | N | 设备ID |
| params | array | N | 字符串数组，指定要查询的参数。如果为空表示查询所有参数 |
| userAgent | string | N | app或者device|
| sequence | string | N | 时间戳精确到毫秒 |
| ts | number | N | 固定参数: 0|

示例:

```json
{
    "action":"query",
    "deviceid":"1000000001",
    "apikey":"用户APIKEY",
    "sequence": "1585297259553",
    "params":["switch","timers"], // 如果返回为空，可以使用[]查询所有字段状态
  	"ts": 0,
  	"from": "app",
    "userAgent": "app"
}
```

params说明:

此参数内容来自于协议文档，不同设备不同协议内容，比如 单通道开关只有一个switch，但多通道设备肯定不止一个switch，灯类设备还能调色调光，参数也有所不同。

协议文档需要向对接销售索要，公版易微联APP未对接设备（无UI）的，如果定制需要额外付费，具体内容咨询对接销售。

**响应参数:**

| 名称 | 类型 | 允许为空 | 说明 |
| :--- | :--- | :--- | :--- |
| error | number | N | 错误码 |
| apikey | string | N | 用户apikey |
| deviceid | string | N | 设备ID |
| params | object | N | 透传参数,服务端不做验证 |

示例:

```json
{
    "error":0,
    "deviceid":"1000000001",
    "apikey":"***************",
    "params":{
    	"switch":"on",
      ...
    }
}
```

## 错误码

### 通用错误码

| **错误码**   | **说明**   |
|:----|:----|
| 400   | 参数错误，通常是缺少接口必须的参数，或者参数的类型或值错误   |
| 401   | access token认证错误，通常是账号被其他人登录，导致当前access token失效   |
| 402   | access token过期   |
| 403   | 找不到接口，通常是接口url写错   |
| 405   | 找不到资源，通常是在后端数据库中查不到必需的数据记录   |
| 406   | 拒绝操作，通常是当前用户无权操作指定资源   |
| 407   | appid无操作权限   |
| 500   | 服务器内部错误，通常是服务端的程序出错   |

### 【用户】相关错误码

| **错误码**   | **说明**   |
|:----|:----|
| 10001   | 登录密码错误   |
| 10002   | 验证码错误   |
| 10003   | 用户不存在   |
| 10004   | 登录的用户不在本区域   |
| 10009   | 注册用户时检查到账号已存在   |
| 10010   | 验证码发送频率过快   |

### 【家庭和房间】相关错误码

| **错误码**   | **说明**   |
|:----|:----|
| 20001   | 首次创建家庭失败   |
| 20002   | 创建家庭或房间时，数量超出限制   |
| 20003   | 只有一个家庭，拒绝删除   |

### 【设备】相关错误码

| **错误码**   | **说明**   |
|:----|:----|
| 30003   | 添加GSM设备时，发送notify通知（以告知设备断开临时长连接）失败   |
| 30007   | 添加GSM时，因为设备已经被其他账号添加，导致本次添加失败   |
| 30008   | 分享设备时，分享者的账号不存在   |
| 30009   | 新增设备群组超过了数量限制   |
| 30010   | 添加设备时，设备id格式错误   |
| 30011   | 添加设备时，出厂信息不存在   |
| 30012   | 添加设备时，出厂信息的extra字段不存在   |
| 30013   | 添加设备时，出厂 信息中的品牌信息不存在   |
| 30014   | 添加设备时，chipid错误   |
| 30015   | 添加设备时，digest错误   |
| 30016   | 添加设备时，appid信息不存在   |
| 30017   | 添加设备时，拒绝该appid登录的用户添加该品牌的设备   |
| 30018   | 添加设备时，找不到deviceid对应的设备信息   |
| 30019   | 添加设备时，出厂信息中的产品型号信息不存在   | 